#Lv04-1
## 1) Theory

* 단위 테스트로 클래스의 행동 계약을 고정한다.
* PasswordEncoder는 솔트 포함이므로 해시는 호출마다 달라진다.
* 검증 포인트:

  1. `matches(raw, encode(raw))`는 true
  2. 다른 비밀번호는 false
  3. 두 번 인코딩 결과는 서로 다름

## 2) Example code

```java
package org.example.expert.config;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class PasswordEncoderTest {
    private final PasswordEncoder encoder = new PasswordEncoder();

    @Test
    void encode_then_match_true() {
        String raw = "Abcd1234!";
        String hash = encoder.encode(raw);
        assertTrue(encoder.matches(raw, hash));
    }

    @Test
    void wrong_password_false() {
        String hash = encoder.encode("Abcd1234!");
        assertFalse(encoder.matches("Wrong123!", hash));
    }

    @Test
    void salted_hash_differs_each_time() {
        String h1 = encoder.encode("Abcd1234!");
        String h2 = encoder.encode("Abcd1234!");
        assertNotEquals(h1, h2);
    }
}
```

## 3) Execution and testing method

```bash
./gradlew test --tests 'org.example.expert.config.PasswordEncoderTest'
```

* 녹색이면 계약 유지 확인 완료.

## 캡쳐
![](Lv04_1.png)

---

#Lv04-2
## 1) Theory

* 의미 구분:

  * InvalidRequestException → 클라이언트 잘못(400).
  * ServerException → 서버 내부 오류(5xx).
* “Todo not found”는 보통 400/404 범주. 따라서 테스트는 `InvalidRequestException` 기대가 자연스럽다.
* 실패 원인: 테스트 기대 타입(ServerException) ≠ 실제 던진 타입(InvalidRequestException).

## 2) Example code

### 권장: 테스트 수정

```java
// given
given(todoRepository.findById(anyLong())).willReturn(Optional.empty());

// when
InvalidRequestException ex =
    assertThrows(InvalidRequestException.class,
        () -> commentService.saveComment(authUser, todoId, request));

// then
assertEquals("Todo not found", ex.getMessage());
```

### 대안 A: 서비스 수정(테스트 유지)

```java
// CommentService.saveComment(...)
if (todoRepository.findById(todoId).isEmpty()) {
    throw new ServerException("Todo not found");
}
```

### 대안 B: 예외 계층 정리

```java
public class InvalidRequestException extends ServerException { ... }
// 그럼 테스트는 ServerException.class로도 통과
```

## 3) Execution and testing method

```bash
./gradlew test --tests 'org.example.expert.domain.comment.service.CommentServiceTest'
```

* 초록색이면 정상.

## 캡쳐
![](Lv04_02.png)

---

# Lv04-3,4
## 1) scope

* 대상: `ManagerService` 단위 테스트 및 예외 처리.
* 목표: `todo.user == null`일 때 **도메인 예외**를 던지도록 수정하고, 목록/등록 테스트를 안정화.

---

## 2) symptom → root\_cause → fix

### A. `todo.user == null`에서 NPE 발생

* **Symptom**

  * 테스트 실패, 스택트레이스에 `NullPointerException`.
  * 기존 코드:

    ```java
    if (!ObjectUtils.nullSafeEquals(user.getId(), todo.getUser().getId())) {
        throw new InvalidRequestException("일정을 생성한 유저만 담당자를 지정할 수 있습니다.");
    }
    ```
* **Root cause**

  * `nullSafeEquals`는 전달된 인자 비교만 안전하게 함.
    `todo.getUser().getId()` 호출 자체는 **null 가드가 없음**.
* **Fix**

  ```java
  User owner = todo.getUser();
  if (owner == null || !Objects.equals(authUser.getId(), owner.getId())) {
      throw new InvalidRequestException("일정을 생성한 유저만 담당자를 지정할 수 있습니다.");
  }
  ```

### B. 저장 성공 테스트에서 `IllegalArgumentException: Could not find field 'user'`

* **Symptom**

  * `ReflectionTestUtils.setField(managerUser, "user", managerUserId);`
* **Root cause**

  * `User` 엔티티 식별자 필드명은 `"id"`. `"user"` 필드 없음.
* **Fix**

  ```java
  ReflectionTestUtils.setField(managerUser, "id", managerUserId);
  ```

### C. 저장 성공 테스트에서 저장 전 조회 스텁 누락

* **Symptom**

  * `saveManager` 내부는 `todoRepository.findById(...)`, `userRepository.findById(...)`를 호출.
* **Fix**

  ```java
  given(todoRepository.findById(todoId)).willReturn(Optional.of(todo));
  given(userRepository.findById(managerUserId)).willReturn(Optional.of(managerUser));
  ```

### D. `save(..)` 스텁 중복/타입 문제

* **Fix** — 하나만 유지:

  ```java
  given(managerRepository.save(any(Manager.class)))
      .willAnswer(inv -> inv.getArgument(0, Manager.class));
  // ID까지 흉내내려면:
  // .willAnswer(inv -> { Manager m = inv.getArgument(0, Manager.class);
  //   ReflectionTestUtils.setField(m, "id", 100L); return m; });
  ```

### E. VM 경고

* **Symptom**

  * `OpenJDK 64-Bit Server VM warning: Sharing is only supported ...`
* **Fix (경고 억제)**

  * `build.gradle`

    ```groovy
    test { jvmArgs '-Xshare:off' }
    tasks.withType(JavaExec).configureEach { jvmArgs '-Xshare:off' }
    ```

---

## 3) reference\_tests (최종 형태)

### A. `todo.user == null` 예외 테스트

```java
@ExtendWith(MockitoExtension.class)
class ManagerServiceTest {

  @Mock TodoRepository todoRepository;
  @InjectMocks ManagerService managerService;

  @Test
  void todo의_user가_null인_경우_예외가_발생한다() {
      AuthUser authUser = new AuthUser(1L, "a@a.com", UserRole.USER);
      long todoId = 1L;
      long managerUserId = 2L;

      Todo todo = org.mockito.Mockito.mock(Todo.class);
      org.mockito.Mockito.when(todo.getUser()).thenReturn(null);

      ManagerSaveRequest req = new ManagerSaveRequest(managerUserId);
      given(todoRepository.findById(todoId)).willReturn(Optional.of(todo));

      InvalidRequestException ex = assertThrows(
          InvalidRequestException.class,
          () -> managerService.saveManager(authUser, todoId, req)
      );
      assertEquals("일정을 생성한 유저만 담당자를 지정할 수 있습니다.", ex.getMessage());
  }
}
```

### B. 목록 조회 성공 테스트

```java
@Test
void manager_목록_조회에_성공한다() {
    long todoId = 1L;
    User user = new User("user1@example.com","password",UserRole.USER);
    Todo todo = new Todo("Title","Contents","Sunny", user);
    ReflectionTestUtils.setField(todo, "id", todoId);

    Manager mockManager = new Manager(todo.getUser(), todo);
    List<Manager> managerList = List.of(mockManager);

    given(todoRepository.findById(todoId)).willReturn(Optional.of(todo));
    given(managerRepository.findByTodoIdWithUser(todoId)).willReturn(managerList);

    List<ManagerResponse> res = managerService.getManagers(todoId);
    assertEquals(1, res.size());
    assertEquals(mockManager.getId(), res.get(0).getId());
    assertEquals(mockManager.getUser().getEmail(), res.get(0).getUser().getEmail());
}
```

### C. 저장 성공 테스트

```java
@Test
void todo가_정상적으로_등록된다() {
    AuthUser authUser = new AuthUser(1L, "a@a.com", UserRole.USER);
    User owner = User.fromAuthUser(authUser);
    long todoId = 1L;
    Todo todo = new Todo("Test Title","Test Contents","Weather", owner);

    long managerUserId = 2L;
    User managerUser = new User("b@b.com","password",UserRole.USER);
    ReflectionTestUtils.setField(managerUser, "id", managerUserId);

    ManagerSaveRequest req = new ManagerSaveRequest(managerUserId);

    given(todoRepository.findById(todoId)).willReturn(Optional.of(todo));
    given(userRepository.findById(managerUserId)).willReturn(Optional.of(managerUser));
    given(managerRepository.save(any(Manager.class)))
        .willAnswer(inv -> inv.getArgument(0, Manager.class));

    ManagerSaveResponse res = managerService.saveManager(authUser, todoId, req);

    assertNotNull(res);
    assertEquals(managerUser.getId(), res.getUser().getId());
    assertEquals(managerUser.getEmail(), res.getUser().getEmail());
}
```


