## given\_when\_then

* **Given**: `@Auth AuthUser` 파라미터가 작동하지 않음. `AuthUserArgumentResolver`가 `org.example.expert.config`에 존재.
* **When**: 리졸버를 스프링 빈으로 만들고 `WebMvcConfigurer#addArgumentResolvers`로 등록. `JwtFilter`에서 `userId/email/userRole`을 `request.setAttribute`로 주입.
* **Then**: 컨트롤러에서 `@Auth AuthUser`가 정상 주입되고 엔드포인트가 기대값 반환.

---

## 1) theory

* `HandlerMethodArgumentResolver`: 컨트롤러 인자 생성 전략. 기본 제공 리졸버로 처리되지 않는 커스텀 요구를 확장.
* 리졸버는 **빈 등록만으로는 동작하지 않음**. `WebMvcConfigurer#addArgumentResolvers`로 MVC 체인에 **명시 등록** 필요.
* 동작 흐름

  1. 요청 진입 → `JwtFilter`가 JWT 검증 후 `request.setAttribute("userId","email","userRole")`.
  2. 매개변수 해석 단계에서 리졸버 목록 순회.
  3. `supportsParameter`가 `@Auth` + `AuthUser` 조합을 감지하면 `resolveArgument` 실행.
  4. `resolveArgument`가 `AuthUser` 인스턴스를 만들어 컨트롤러에 전달.
* 필수 전제

  * `@Auth`는 `@Target(PARAMETER)` + `@Retention(RUNTIME)`.
  * 리졸버는 단일 빈이어야 함(중복 등록 금지).
  * 필터 순서가 너무 뒤면 속성이 비어 있을 수 있으므로 필요한 경우 `setOrder(Highest)`로 조정.

---

## 2) example\_code

```java
// annotation
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface Auth {}
```

```java
// resolver
@Component
public class AuthUserArgumentResolver implements HandlerMethodArgumentResolver {
    @Override
    public boolean supportsParameter(MethodParameter p) {
        boolean has = p.getParameterAnnotation(Auth.class) != null;
        boolean isType = p.getParameterType().equals(AuthUser.class);
        if (has != isType) throw new AuthException("@Auth와 AuthUser 타입은 함께 사용되어야 합니다.");
        return has;
    }

    @Override
    public Object resolveArgument(
            @Nullable MethodParameter p, @Nullable ModelAndViewContainer m,
            NativeWebRequest req, @Nullable WebDataBinderFactory b) {
        var r = (jakarta.servlet.http.HttpServletRequest) req.getNativeRequest();
        Long id = (Long) r.getAttribute("userId");
        String email = (String) r.getAttribute("email");
        UserRole role = UserRole.of((String) r.getAttribute("userRole"));
        return new AuthUser(id, email, role);
    }
}
```

```java
// webmvc_config
@Configuration
@RequiredArgsConstructor
public class WebMvcConfig implements WebMvcConfigurer {
    private final AuthUserArgumentResolver authUserArgumentResolver;
    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(authUserArgumentResolver);
    }
}
```

```java
// filter_snippet (속성 주입)
httpRequest.setAttribute("userId", ((Number) claims.get("userId")).longValue());
httpRequest.setAttribute("email", claims.get("email"));
httpRequest.setAttribute("userRole", claims.get("userRole"));
```

```java
// controller_usage
@GetMapping("/me")
public ResponseEntity<AuthUser> me(@Auth AuthUser user) {
    return ResponseEntity.ok(user);
}
```

---

## 3) execution\_and\_testing\_method

```bash
# 빌드 및 실행
./gradlew clean bootRun

# 등록 확인(리졸버, 설정, 속성 세팅)
grep -R "addArgumentResolvers" src/main/java
grep -R "@Component" src/main/java | grep AuthUserArgumentResolver
grep -R 'setAttribute("userId"\|"email"\|"userRole")' src/main/java

# 실제 JWT로 호출
curl -H "Authorization: Bearer <REAL_JWT>" http://localhost:8080/me
```

* 기대: 응답 JSON에 `userId`, `email`, `userRole` 포함.
* 실패 시 점검:

  * 리졸버 중복 빈 없음 확인.
  * `@Auth` 보존 정책 RUNTIME 확인.
  * 필터 순서와 속성 키 철자 확인.
